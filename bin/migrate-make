#!/usr/bin/env node

var program = require('commander'),
    fs = require('fs'),
    path = require('path'),
    settings = require('../middguard/config/settings'),
    knexConfig = require('../knexfile')[settings.env],
    knex = require('knex')(knexConfig);

program
  .version('0.0.1')
  .option('-n, --name <name>', 'The name for the new migration')
  .option('--model <model>', 'Make a new migration for <model>')
  .option('--middguard', 'Make a new migration for MiddGuard')
  .parse(process.argv);

var migrationsConfig = { database: knexConfig };

console.assert(program.name && program.name !== '',
  'Specify a name for the migration with --name <name>');

console.assert(program.model || program.middguard,
  'Specify middguard with --middguard or a model to migrate with --model <model>');

if (program.middguard) {
  console.assert(!program.model, 'Only specify --model or --middguard');
  migrationsConfig.directory = path.join(settings.root, 'migrations');
}

if (program.model) {
  console.assert(!program.middguard, 'Only specify --model or --middguard');
  migrationsConfig.directory = path.join(settings.root, settings.modelsPath,
    program.model, 'migrations');
}

knex.migrate.make(program.name, migrationsConfig);
